#include "Define.h"
using namespace std;

void trimSpace(string & line) {
  if (line.empty()) {
    return;
  }
  line.erase(0, line.find_first_not_of(" "));
  line.erase(line.find_last_not_of(" ") + 1);
}

string parseCommand(string & line) {
  trimSpace(line);
  string str;
  size_t pos = 0;
  while (pos < line.size()) {
    if ((line[pos] == '(' || line[pos] == ')' || isspace(line[pos]) ||
         line[pos] == '=')) {
      break;
    }
    pos++;
  }
  if (pos == 0) {
    pos += 1;
  }
  str = line.substr(0, pos);
  trimSpace(str);
  line.erase(0, pos);
  trimSpace(str);
  return str;
}

string parseWord(string & line) {
  trimSpace(line);
  string str;
  size_t pos = 0;

  while (pos < line.size()) {
    if ((line[pos] == '(' || line[pos] == ')' || isspace(line[pos]) ||
         line[pos] == '=')) {
      break;
    }
    pos++;
  }
  if (pos == 0) {
    pos += 1;
  }

  str = line.substr(0, pos);
  trimSpace(str);
  line.erase(0, pos);
  trimSpace(line);
  return str;
}

//define (id var var)
void parseDefine(string & line, map<string, Function *> & functions) {
  if (line.find("=") == string::npos) {
    cout << "cannot find =" << endl;
    return;
  }
  string str1 = line.substr(0, line.find("="));
  string str2 = line.substr(line.find("=") + 1);
  //working on str1 before the =
  string id;
  map<string, double> vars;
  vector<string> str1_v;
  //compare repeatation of vars
  while (!str1.empty()) {
    str1_v.push_back(parseWord(str1));
  }
  size_t i = 1;
  if (str1_v[0] != "(") {
    cout << "need to start with a (" << endl;
    return;
  }

  while (i < str1_v.size() - 1) {
    if (i == 1) {
      id = str1_v[i];

      if (functions.find(id) != functions.end()) {
        cout << "function " << id << " has been defined" << endl;
        return;
      }
    }
    else {
      vars.insert(pair<string, double>(str1_v[i], 0.0));
    }
    i++;
  }
  if (vars.size() == 0) {
    cout << "no variable can be found" << endl;
    return;
  }
  //working on str2 after "="
  trimSpace(str2);

  if (isMatch(str2)) {
    Function * function = new Function(str2, vars);
    functions.insert(pair<string, Function *>(id, function));
  }
  else {
    cout << "define line does not have matched parentheses" << endl;
    return;
  }

  cout << "defined " << id << "(";
  string display;
  for (map<string, double>::iterator it = vars.begin(); it != vars.end(); it++) {
    display += (it->first);
    display += (" ");
  }
  display.erase(display.size() - 1, display.size());
  cout << display << ")" << endl;
}
